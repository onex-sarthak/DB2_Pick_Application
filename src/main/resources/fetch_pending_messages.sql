CREATE OR REPLACE PROCEDURE SMS_SCHEMA.FETCH_PENDING_MESSAGES(
    IN BATCH_SIZE INTEGER
)
LANGUAGE SQL
SPECIFIC FETCH_PENDING_MESSAGES
RESULT SETS 1
BEGIN
    -- Declare cursor
    DECLARE message_cursor CURSOR WITH RETURN FOR
SELECT *
FROM SMS_SCHEMA.MESSAGE_INFO
WHERE STATUS_FLAG = 0
ORDER BY TIMESTAMP ASC
    FETCH FIRST BATCH_SIZE ROWS ONLY;

-- Set lock wait timeout to prevent deadlocks
SET CURRENT LOCK TIMEOUT 10;

    -- Open the cursor
OPEN message_cursor;
END;